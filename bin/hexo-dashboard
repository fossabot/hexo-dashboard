#!/usr/bin/env node

const { join, resolve } = require('node:path');
const { readFileSync, writeFileSync, existsSync } = require('fs');
const { hashSync } = require('bcryptjs');
const readline = require('readline');

// ============================================================================
// Help
// ============================================================================

const showHelp = () => {
    console.log(`
hexo-dashboard - User management CLI

Usage:
    hexo-dashboard <command> [options]

Commands:
    register <username>   Add a new user (alias: reg)
    passwd <username>     Change user password
    delete <username>                Delete a user (alias: del, rm, remove)
    list                             List all users (alias: ls)
    help                             Show this help message

Examples:
    hexo-dashboard register admin
    hexo-dashboard passwd admin
    hexo-dashboard delete admin
    hexo-dashboard list
    `);
};

// ============================================================================
// Password input
// ============================================================================

/**
 * Read password from stdin without echoing
 */
const readPassword = (prompt) => {
    return new Promise((resolve) => {
        const rl = readline.createInterface({
            input: process.stdin,
            output: process.stdout
        });

        // Disable echo
        process.stdout.write(prompt);
        process.stdin.setRawMode(true);
        process.stdin.resume();

        let password = '';
        const onData = (char) => {
            const c = char.toString();
            if (c === '\n' || c === '\r' || c === '\u0004') {
                // Enter or Ctrl+D
                process.stdin.setRawMode(false);
                process.stdin.removeListener('data', onData);
                rl.close();
                console.log();
                resolve(password);
            } else if (c === '\u0003') {
                // Ctrl+C
                process.stdin.setRawMode(false);
                process.exit(1);
            } else if (c === '\u007F' || c === '\b') {
                // Backspace
                if (password.length > 0) {
                    password = password.slice(0, -1);
                }
            } else {
                password += c;
            }
        };

        process.stdin.on('data', onData);
    });
};

/**
 * Get password - from interactive input
 */
const getPassword = async (promptText = 'Password: ') => {
    const password = await readPassword(promptText);
    if (!password) {
        console.error('Error: Password cannot be empty.');
        process.exit(1);
    }
    return password;
};

// ============================================================================
// Config file operations
// ============================================================================

/**
 * Find hexo project directory by looking for _config.yml
 */
const findConfigPath = () => {
    let dir = process.cwd();
    for (let i = 0; i < 5; i++) {
        const configPath = join(dir, '_config.yml');
        if (existsSync(configPath)) return configPath;
        const parent = resolve(dir, '..');
        if (parent === dir) break;
        dir = parent;
    }
    return null;
};

/**
 * Parse dashboard users from config content
 */
const parseUsers = (content) => {
    const users = {};
    const match = content.match(/^dashboard:\s*\n((?:[ \t]+.+\n?)*)/m);
    if (!match) return users;

    const lines = match[1].split('\n');
    for (const line of lines) {
        const userMatch = line.match(/^\s+(\w+):\s*(.+?)\s*$/);
        if (userMatch) {
            users[userMatch[1]] = userMatch[2];
        }
    }
    return users;
};

/**
 * Serialize users object to YAML format
 */
const serializeUsers = (users) => {
    const lines = ['dashboard:'];
    for (const [name, hash] of Object.entries(users)) {
        lines.push(`  ${name}: ${hash}`);
    }
    return lines.join('\n');
};

/**
 * Write users to config file, preserving other content
 */
const writeUsers = (configPath, content, users) => {
    const hasUsers = Object.keys(users).length > 0;
    const hasDashboard = /^dashboard:\s*$/m.test(content) || /^dashboard:\s*\n/m.test(content);

    let newContent;

    if (hasDashboard) {
        // Replace existing dashboard section
        const pattern = /^dashboard:\s*\n(?:[ \t]+.+\n?)*/m;
        if (hasUsers) {
            newContent = content.replace(pattern, serializeUsers(users) + '\n');
        } else {
            // Remove dashboard section
            newContent = content.replace(pattern, '').replace(/\n{3,}/g, '\n\n').trimEnd() + '\n';
        }
    } else if (hasUsers) {
        // Append new dashboard section
        const ending = content.endsWith('\n') ? '\n' : '\n\n';
        newContent = content + ending + '# Hexo-dashboard authentication\n' + serializeUsers(users) + '\n';
    } else {
        return; // Nothing to do
    }

    writeFileSync(configPath, newContent, 'utf-8');
};

// ============================================================================
// Commands
// ============================================================================

const commands = {
    async register(users, args, configPath, content) {
        const [username] = args;
        if (!username) {
            console.error('Usage: hexo-dashboard register <username>');
            process.exit(1);
        }
        if (users[username]) {
            console.error(`Error: User '${username}' already exists. Use 'passwd' to change password.`);
            process.exit(1);
        }
        const password = await getPassword();
        users[username] = hashSync(password, 12);
        writeUsers(configPath, content, users);
        console.log(`✓ User '${username}' registered successfully!`);
        console.log(`  Config: ${configPath}`);
    },

    async passwd(users, args, configPath, content) {
        const [username] = args;
        if (!username) {
            console.error('Usage: hexo-dashboard passwd <username>');
            process.exit(1);
        }
        if (!users[username]) {
            console.error(`Error: User '${username}' not found.`);
            process.exit(1);
        }
        const password = await getPassword();
        users[username] = hashSync(password, 12);
        writeUsers(configPath, content, users);
        console.log(`✓ Password for '${username}' changed successfully!`);
        console.log(`  Config: ${configPath}`);
    },

    delete(users, args, configPath, content) {
        const [username] = args;
        if (!username) {
            console.error('Usage: hexo-dashboard delete <username>');
            process.exit(1);
        }
        if (!users[username]) {
            console.error(`Error: User '${username}' not found.`);
            process.exit(1);
        }
        delete users[username];
        writeUsers(configPath, content, users);
        console.log(`✓ User '${username}' deleted successfully!`);
        console.log(`  Config: ${configPath}`);
    },

    list(users) {
        const names = Object.keys(users);
        if (names.length === 0) {
            console.log('No users registered.');
        } else {
            console.log(`Registered users (${names.length}):`);
            names.forEach(name => console.log(`  - ${name}`));
        }
    }
};

// Command aliases
commands.reg = commands.register;
commands.del = commands.delete;
commands.rm = commands.delete;
commands.remove = commands.delete;
commands.ls = commands.list;

// ============================================================================
// Main
// ============================================================================

const main = async () => {
    const args = process.argv.slice(2);
    const command = args[0];

    // Help
    if (!command || command === 'help' || command === '-h' || command === '--help') {
        showHelp();
        process.exit(0);
    }

    // Validate command
    if (!commands[command]) {
        console.error(`Unknown command: ${command}`);
        showHelp();
        process.exit(1);
    }

    // Find config
    const configPath = findConfigPath();
    if (!configPath) {
        console.error('Error: _config.yml not found.');
        console.error('Please run this command in your Hexo project directory.');
        process.exit(1);
    }

    // Execute
    try {
        const content = readFileSync(configPath, 'utf-8');
        const users = parseUsers(content);
        await commands[command](users, args.slice(1), configPath, content);
    } catch (err) {
        console.error(`Error: ${err.message}`);
        process.exit(1);
    }
};

main();
